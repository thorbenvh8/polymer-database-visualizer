<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="elements/database-schema.html">
<!--
<link rel="import" href="bower_components/paper-menu/paper-menu.html">
<link rel="import" href="bower_components/paper-menu/paper-submenu.html">
<link rel="import" href="bower_components/paper-item/paper-item.html">
-->
<link rel="stylesheet" href="stylesheet.css">
<link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.min.css">

<!--
An element providing a solution to no problem in particular.

Example:

    <database-visualizer></database-visualizer>

@demo
-->
<dom-module id="database-visualizer">

  <style>
    :host {
      overflow: hidden;
      font-family: 'Roboto','Noto',sans-serif;
      display: block;
      box-sizing: content-box;
      height: 100%;
      background-color: #ECECEC;
    }
  </style>

  <template>
    <h1>&lt;database-visualizer&gt;</h1>
    <div class="empty hidden">nothing loaded</div>
    <div class="loading hidden">
      <div class="spinner">
        <div class="rect1"></div>
        <div class="rect2"></div>
        <div class="rect3"></div>
        <div class="rect4"></div>
        <div class="rect5"></div>
      </div>
    </div>
    <div class="minimap"><div class="visible-area"></div></div>
    <div class="database-visualizer-canvas" style="left: 0px; top: 0px;">
      <template is="dom-repeat" items="{{database.schemas}}">
        <database-schema id="{{item.name}}" schema="{{item}}"></database-schema>
      </template>
      <div class="database-constraints-storage"></div>
    </div>
  </template>

</dom-module>

<script>
  // TODO add testing with nightwatch.js (www.nightwatchjs.org)
  // TODO screenshot gatlin

  // TODO tryout dc/os

  Polymer({

    is: 'database-visualizer',

    properties: {
      database: {
        type: Object,
        notify: true,
        value: function() {
          return {
            schemas:  [{name: "schema1",
                        tables: [{name: "table1"}]}],
            foreignKeys: [{column: "column1"}]
          };
        },
        observer: 'databaseChanged'
      },

      _schemas: {
        type: Array,
        notify: true,
        value: function() {
          return [];
        }
      },

      _scale: {
        type: Number,
        value: function () {
          return 1;
        }
      },

      _moveX: {
        type: Number,
        value: function () {
          return 0;
        }
      },

      _moveY: {
        type: Number,
        value: function () {
          return 0;
        }
      },
      _minimapMoveX: Number,
      _minimapMoveY: Number,
      _moveDiffX: {
        type: Number,
        value: function () {
          return 0;
        }
      },
      _moveDiffY: {
        type: Number,
        value: function () {
          return 0;
        }
      },

      _draggingChild: Boolean,
      _dragging: Boolean,

      _dragX: Number,
      _dragY: Number,

      _minimapWidth: Number,
      _minimapHeight: Number
    },

    databaseChanged(database) {
      if (database === null || database === "" || database.schemas === null || database.schemas === "" || database.schemas.length <= 0) {
        $('.empty').removeClass('hidden');
        $('.minimap').addClass('hidden');
      } else {
        $('.loading').removeClass('hidden');
        $('.empty').addClass('hidden');
        $('.minimap').removeClass('hidden');
      }
    },

    getSchemas() {
      return this._schemas;
    },
    registerSchema(schema) {
      this.getSchemas().push(schema);

      if (this.database.schemas.length === this.getSchemas().length) {
        this.refresh();
        this.refreshMinimap();
        this.refreshMinimapZoom();

        var databaseVisualizer = this;
        setTimeout(function() {
          console.log("refresh");
          databaseVisualizer.refresh();
        }, 500);
      }
    },

    setMoveX(moveX) {
      this._moveX = moveX;
    },
    getMoveX() {
      return this._moveX;
    },
    setMoveY(moveY) {
      this._moveY = moveY;
    },
    getMoveY() {
      return this._moveY;
    },

    setMoveDiffX(moveDiffX) {
      this._moveDiffX = moveDiffX;
    },
    getMoveDiffX() {
      return this._moveDiffX;
    },
    setMoveDiffY(moveDiffY) {
      this._moveDiffY = moveDiffY;
    },
    getMoveDiffY() {
      return this._moveDiffY;
    },

    setMinimapMoveX(minimapMoveX) {
      this._minimapMoveX = minimapMoveX;
    },
    getMinimapMoveX() {
      return this._minimapMoveX;
    },
    setMinimapMoveY(minimapMoveY) {
      this._minimapMoveY = minimapMoveY;
    },
    getMinimapMoveY() {
      return this._minimapMoveY;
    },

    getScale() {
      return this._scale;
    },

    setScale(scale) {
      return this._scale = scale;
    },

    setDragging(bool) {
      this._dragging = bool;
    },
    getDragging() {
      return this._dragging;
    },

    setDraggingChild(bool) {
      this._draggingChild = bool;
    },
    getDraggingChild() {
      return this._draggingChild;
    },

    setDragY(bool) {
      this._dragY = bool;
    },
    getDragY() {
      return this._dragY;
    },

    setDragX(bool) {
      this._dragX = bool;
    },
    getDragX() {
      return this._dragX;
    },
    
    setMinimapWidth(minimapWidth) {
      this._minimapWidth = minimapWidth;
    },
    getMinimapWidth() {
      return this._minimapWidth;
    },
    setMinimapHeight(minimapHeight) {
      this._minimapHeight = minimapHeight;
    },
    getMinimapHeight() {
      return this._minimapHeight;
    },

    refreshMinimapZoom() {
      var mostLeft = null;
      var mostTop = null;

      $.each(this.getSchemas(), function() {

        if(mostLeft === null || mostLeft > $(this).offset().left ) {
          mostLeft = $(this).offset().left;
        }
        if(mostTop === null || mostTop > $(this).offset().top ) {
          mostTop = $(this).offset().top;
        }
      });
      var ratio = $(this).height() / $(this).width();

      var topHalf = (this.getMinimapWidth() - this.getMinimapHeight()) / 2;

      $(this).find('.minimap .visible-area').width(150 * $(this).width() / this.getMinimapWidth() / this.getScale());
      $(this).find('.minimap .visible-area').height(150 * $(this).width() / this.getMinimapWidth() / this.getScale() * ratio);
      $(this).find('.minimap .visible-area').css({
        left: 150 * (50 - mostLeft / this.getScale()) / this.getMinimapWidth(),
        top: 150 * (topHalf - mostTop / this.getScale()) / this.getMinimapWidth()
      });
    },

    refreshMinimap() {
      $(this).find('.minimap .schema').remove();

      var mostLeft = null;
      var mostRight = null;
      var mostTop = null;
      var mostBottom = null;
      $.each(this.getSchemas(), function() {
        if(mostLeft === null || mostLeft > this.getLeft() ) {
          mostLeft = this.getLeft();
        }
        if(mostTop === null || mostTop > this.getTop() ) {
          mostTop = this.getTop();
        }
        if(mostRight === null || mostRight < this.getLeft() + this.getWidth() ) {
          mostRight = this.getLeft() + this.getWidth();
        }
        if(mostBottom === null || mostBottom < this.getTop() + this.getHeight() ) {
          mostBottom = this.getTop() + this.getHeight();
        }
      });

      mostRight = mostRight + 50;
      mostLeft = mostLeft - 50;
      this.setMinimapWidth(Math.abs(mostRight - mostLeft));
      this.setMinimapHeight(Math.abs(mostBottom - mostTop));

      var ratio = this.getMinimapWidth() / 150;

      var paddingTop = (150 - this.getMinimapHeight() / ratio) / 2;

      var databaseVisualizer = this;
      $.each(this.getSchemas(), function() {
        var $schema = $('<div></div>');
        $schema.addClass('schema');
        $schema.css({
          left: (this.getLeft() - mostLeft) / ratio,
          top: (this.getTop() - mostTop) / ratio + paddingTop,
          width: this.getWidth() / ratio,
          height: this.getHeight() / ratio
        });

        $.each(this.getTables(), function() {
          var $table = $('<div></div>');
          $table.addClass('table');
          $table.css({
            left: this.getLeft() / ratio,
            top: this.getTop() / ratio,
            width: $(this).width() / ratio,
            height: $(this).height() / ratio
          });
          $schema.append($table);
        });

        $(databaseVisualizer).find('.minimap').append($schema);
      });
    },

    refresh() {
      $.each(this.getSchemas(), function() {
        this.refresh();
      });
    },

    // Element Lifecycle

    ready: function() {
      // `ready` is called after all elements have been configured, but
      // propagates bottom-up. This element's children are ready, but parents
      // are not.
      //
      // This is the point where you should make modifications to the DOM (when
      // necessary), or kick off any processes the element wants to perform.
    },

    attached: function() {
      // `attached` fires once the element and its parents have been inserted
      // into a document.
      //
      // This is a good place to perform any work related to your element's
      // visual state or active behavior (measuring sizes, beginning animations,
      // loading resources, etc).

      var databaseVisualizer = this;

      var visibleTop;
      var visibleLeft;
      var mousedown = false;

      $(this).find('.minimap .visible-area').on('mousedown', function() {
        $(this).addClass('cursor-webkit-grabbing');

        mousedown = true;
        databaseVisualizer.setDragX(event.pageX - $(this).parent().offset().left);
        databaseVisualizer.setDragY(event.pageY - $(this).parent().offset().top);

        visibleTop = $(this).position().top;
        visibleLeft = $(this).position().left;
      });
      $(this).find('.minimap .visible-area').on('mousemove', function() {
        if (mousedown) {
          // find current location on screen
          var screenX = event.pageX - $(this).parent().offset().left;
          var screenY = event.pageY - $(this).parent().offset().top;
          
          databaseVisualizer.setMinimapMoveX(databaseVisualizer.getMoveX() - (screenX - databaseVisualizer.getDragX()) * databaseVisualizer.getMinimapWidth() / 150);
          databaseVisualizer.setMinimapMoveY(databaseVisualizer.getMoveY() - (screenY - databaseVisualizer.getDragY()) * databaseVisualizer.getMinimapWidth() / 150);

          $(this).css({
            top: visibleTop + (screenY - databaseVisualizer.getDragY()),
            left: visibleLeft + (screenX - databaseVisualizer.getDragX())
          });

          $(databaseVisualizer).find('.database-visualizer-canvas')
                  .css('transform', 'scale(' + databaseVisualizer.getScale() + ')' + 'translate(' + databaseVisualizer.getMinimapMoveX() + 'px, ' + databaseVisualizer.getMinimapMoveY() + 'px' + ')');
        }
      });
      var mouseUpOrLeave = function() {
        if (mousedown) {
          mousedown = false;
          $(this).removeClass('cursor-webkit-grabbing');
          databaseVisualizer.setMoveDiffX(databaseVisualizer.getMoveDiffX() + databaseVisualizer.getMinimapMoveX() - databaseVisualizer.getMoveX());
          databaseVisualizer.setMoveDiffY(databaseVisualizer.getMoveDiffY() + databaseVisualizer.getMinimapMoveY() - databaseVisualizer.getMoveY());
          databaseVisualizer.setMoveX(databaseVisualizer.getMinimapMoveX());
          databaseVisualizer.setMoveY(databaseVisualizer.getMinimapMoveY());
        }
      };
      $(this).find('.minimap .visible-area').on('mouseup', mouseUpOrLeave);
      $(document).on('mouseup', mouseUpOrLeave);

      var xImage = 0; // last x location on the image
      var yImage = 0; // last y location on the image
      var xLast = 0;  // last x location on the screen
      var yLast = 0;  // last y location on the screen

      $(this).bind('mousewheel', function(event, delta) {
        // find current location on screen
        var screenX = event.pageX - $(this).offset().left;
        var screenY = event.pageY - $(this).offset().top;

        // find current location on the image at the current scale
        xImage = xImage + ((screenX - xLast) / this.getScale());
        yImage = yImage + ((screenY - yLast) / this.getScale());

        // determine the new scale
        let scale = this.getScale() *  (1 + delta / 100);
        if (scale < 0.05) {
          scale = 0.05;
        } else if (scale > 3) {
          scale = 3;
        }


        // determine the location on the screen at the new scale
        this.setMoveX((screenX - xImage) / scale + this.getMoveDiffX());
        this.setMoveY((screenY - yImage) / scale + this.getMoveDiffY());

        // save the current screen location
        xLast = screenX;
        yLast = screenY;

        // redraw

          this.setScale(scale);
          $(this).find('.database-visualizer-canvas')
                  .css('transform', 'scale(' + scale + ')' + 'translate(' + this.getMoveX() + 'px, ' + this.getMoveY() + 'px' + ')')
                  .css('transform-origin', xImage + 'px ' + yImage + 'px');

        this.refreshMinimapZoom();
        return false;
      });

      /** mousedown **/
      $(this).bind('mousedown', function(event) {
        databaseVisualizer.setDragging(event.target === databaseVisualizer || event.target === $(databaseVisualizer).find('.database-visualizer-canvas')[0] || event.target === $(databaseVisualizer).children('h1')[0]);
        if (databaseVisualizer.getDragging()) {
          $(databaseVisualizer).addClass('cursor-webkit-grabbing');
          $(databaseVisualizer).find('.database-visualizer-canvas').addClass('cursor-webkit-grabbing');

          databaseVisualizer.setDragX(event.pageX - $(databaseVisualizer).offset().left);
          databaseVisualizer.setDragY(event.pageY - $(databaseVisualizer).offset().top);
        }
      });
      /** mousemove **/
      $(this).bind('mousemove', function(event) {
        if (!databaseVisualizer.getDraggingChild() && databaseVisualizer.getDragging()) {

          // find current location on screen
          var xScreen = event.pageX - $(databaseVisualizer).offset().left;
          var yScreen = event.pageY - $(databaseVisualizer).offset().top;

          databaseVisualizer.setMinimapMoveX(databaseVisualizer.getMoveX() + (xScreen - databaseVisualizer.getDragX()) / databaseVisualizer.getScale());
          databaseVisualizer.setMinimapMoveY(databaseVisualizer.getMoveY() + (yScreen - databaseVisualizer.getDragY()) / databaseVisualizer.getScale());

          $(databaseVisualizer).find('.database-visualizer-canvas')
                  .css('transform', 'scale(' + databaseVisualizer.getScale() + ')' + 'translate(' + databaseVisualizer.getMinimapMoveX() + 'px, ' + databaseVisualizer.getMinimapMoveY() + 'px' + ')');

          this.refreshMinimapZoom();
        }

        return true;
      });

      /** mouseup || mouseleave **/
      var databaseVisualizerMouseUpOrLeave = function() {
        if (databaseVisualizer.getDragging()) {
          $(databaseVisualizer).removeClass('cursor-webkit-grabbing');
          $(databaseVisualizer).find('.database-visualizer-canvas').removeClass('cursor-webkit-grabbing');
          databaseVisualizer.setMoveDiffX(databaseVisualizer.getMoveDiffX() + databaseVisualizer.getMinimapMoveX() - databaseVisualizer.getMoveX());
          databaseVisualizer.setMoveDiffY(databaseVisualizer.getMoveDiffY() + databaseVisualizer.getMinimapMoveY() - databaseVisualizer.getMoveY());
          databaseVisualizer.setMoveX(databaseVisualizer.getMinimapMoveX());
          databaseVisualizer.setMoveY(databaseVisualizer.getMinimapMoveY());
          databaseVisualizer.setDragging(false);
        }
      };
      $(this).bind('mouseup', databaseVisualizerMouseUpOrLeave);
      $(document).bind('mouseleave', databaseVisualizerMouseUpOrLeave);

      setTimeout(function() {
        databaseVisualizer.refresh();
      }, 200);

    },


    detached: function() {
      // The analog to `attached`, `detached` fires when the element has been
      // removed from a document.
      //
      // Use this to clean up anything you did in `attached`.
    }

  });

</script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-mousewheel/3.1.13/jquery.mousewheel.js"></script>
<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/themes/smoothness/jquery-ui.css">
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>

