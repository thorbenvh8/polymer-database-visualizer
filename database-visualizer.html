<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="elements/database-schema.html">
<link rel="import" href="elements/database-constraint-line.html">
<link rel="stylesheet" href="stylesheet.css">
<link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.min.css">

<!--
An element providing a solution to no problem in particular.

Example:

    <database-visualizer></database-visualizer>

@demo
-->
<dom-module id="database-visualizer">

  <style>
    :host {
      overflow: hidden;
      font-family: 'Roboto','Noto',sans-serif;
      display: block;
      box-sizing: content-box;
      height: 100%;
      background-color: #ECECEC;
    }
  </style>

  <template>
    <h1>&lt;database-visualizer&gt;</h1>
    <div class="minimap"><div class="visible-area"></div></div>
    <div class="database-visualizer-canvas" style="left: 0px; top: 0px;">
      <template is="dom-repeat" items="{{database.schemas}}">
        <database-schema id="{{item.name}}" schema="{{item}}"></database-schema>
      </template>
      <div class="database-constraints-storage"></div>
    </div>
  </template>

</dom-module>

<script>
  // TODO add testing with nightwatch.js (www.nightwatchjs.org)
  // TODO screenshot gatlin

  // TODO tryout dc/os

  Polymer({

    is: 'database-visualizer',


    properties: {

      /**
       * `fancy` indicates that the element should don a monocle and tophat,
       * while checking its pocket watch.
       */
      fancy: Boolean,

      database: {
        type: Object,
        notify: true,
        value: function() {
          return {
            schemas:  [{name: "schema1",
                        tables: [{name: "table1"}]}],
            foreignKeys: [{column: "column1"}]
          };
        }
      },

      schemas: {
        type: Array,
        notify: true,
        value: function() {
          return [];
        }
      },

      scale: {
        type: Number,
        value: function () {
          return 1;
        }
      },

      xNew: {
        type: Number,
        value: function () {
          return 0;
        }
      },

      yNew: {
        type: Number,
        value: function () {
          return 0;
        }
      },
      xNew2: Number,
      yNew2: Number,
      xDiffNew: {
        type: Number,
        value: function () {
          return 0;
        }
      },
      yDiffNew: {
        type: Number,
        value: function () {
          return 0;
        }
      },

      draggingChild: Boolean,
      dragging: Boolean,

      xDragScreen: Number,
      yDragScreen: Number,

      widthMinimap: Number,
      heightMinimap: Number
    },

    registerSchema(schema) {
      this.schemas.push(schema);

      if (this.database.schemas.length === this.schemas.length) {
        console.log("refreshMinimap");
        this.refreshMinimap();
        this.refreshMinimapZoom();
      }
    },

    refreshMinimapZoom() {


      console.log("$(this).width(): " + $(this).width());
      console.log("this.widthMinimap: " + this.widthMinimap);

      var mostLeft = null;
      var mostRight = null;
      var mostTop = null;
      var mostBottom = null;
      $.each(this.schemas, function() {

        if(mostLeft === null || mostLeft > $(this).offset().left ) {
          mostLeft = $(this).offset().left;
        }
        if(mostTop === null || mostTop > $(this).offset().top ) {
          mostTop = $(this).offset().top;
        }
        /*
        if(mostRight === null || mostRight < this.left + this.width ) {
          mostRight = this.left + this.width;
        }
        if(mostBottom === null || mostBottom < this.top + this.height ) {
          mostBottom = this.top + this.height;
        }
        */
      });
      var ratio = $(this).height() / $(this).width();

      var topHalf = (this.widthMinimap - this.heightMinimap) / 2;

      $(this).find('.minimap .visible-area').width(150 * $(this).width() / this.widthMinimap / this.getScale());
      $(this).find('.minimap .visible-area').height(150 * $(this).width() / this.widthMinimap / this.getScale() * ratio);
      $(this).find('.minimap .visible-area').css({
        left: 150 * (50 - mostLeft / this.getScale()) / this.widthMinimap,
        top: 150 * (topHalf - mostTop / this.getScale()) / this.widthMinimap
      })
    },

    refreshMinimap() {
      $(this).find('.minimap .schema').remove();

      var mostLeft = null;
      var mostRight = null;
      var mostTop = null;
      var mostBottom = null;
      $.each(this.schemas, function() {
        if(mostLeft === null || mostLeft > this.left ) {
          mostLeft = this.left;
        }
        if(mostTop === null || mostTop > this.top ) {
          mostTop = this.top;
        }
        if(mostRight === null || mostRight < this.left + this.width ) {
          mostRight = this.left + this.width;
        }
        if(mostBottom === null || mostBottom < this.top + this.height ) {
          mostBottom = this.top + this.height;
        }
      });

      console.log("mostLeft: " + mostLeft);
      console.log("mostTop: " + mostTop);
      console.log("mostRight: " + mostRight);
      console.log("mostBottom: " + mostBottom);

      mostRight = mostRight + 50;
      mostLeft = mostLeft - 50;
      this.widthMinimap = Math.abs(mostRight - mostLeft)
      this.heightMinimap = Math.abs(mostBottom - mostTop);

      var ratio = this.widthMinimap / 150;

      var paddingTop = (150 - this.heightMinimap / ratio) / 2;
      console.log("paddingTop: " + paddingTop);

      var databaseView = this;
      $.each(this.schemas, function() {
        var $schema = $('<div></div>');
        $schema.addClass('schema');
        $schema.css({
          left: (this.left - mostLeft) / ratio,
          top: (this.top - mostTop) / ratio + paddingTop,
          width: this.width/ ratio,
          height: this.height / ratio
        });

        $.each(this.tables, function() {
          var $table = $('<div></div>');
          $table.addClass('table');
          $table.css({
            left: this.left / ratio,
            top: this.top / ratio,
            width: $(this).width() / ratio,
            height: $(this).height() / ratio
          });
          $schema.append($table);
        });

        $(databaseView).find('.minimap').append($schema);
      });
    },

    getScale() {
      return this.scale;
    },

    setScale(scale) {
      return this.scale = scale;
    },

    setDraggingChild(b) {
      this.draggingChild = b;
    },

    refresh() {
      $.each(this.schemas, function() {
        this.refresh();
      });
    },

    // Element Lifecycle

    ready: function() {
      // `ready` is called after all elements have been configured, but
      // propagates bottom-up. This element's children are ready, but parents
      // are not.
      //
      // This is the point where you should make modifications to the DOM (when
      // necessary), or kick off any processes the element wants to perform.
    },

    attached: function() {
      // `attached` fires once the element and its parents have been inserted
      // into a document.
      //
      // This is a good place to perform any work related to your element's
      // visual state or active behavior (measuring sizes, beginning animations,
      // loading resources, etc).

     /* $(this).mousemove(function(event){
        var mouseOffsetX = event.offsetX;
        var mouseOffsetY = event.offsetY;
        console.log("mouse offset: (" + mouseOffsetX + ", " + mouseOffsetY + ")");

        var canvasOffsetX = $(".database-visualizer-canvas").offset().left;
        var canvasOffsetY = $(".database-visualizer-canvas").offset().top;
        console.log("canvas offset: (" + canvasOffsetX + ", " + canvasOffsetY + ")");

        var divX = Math.abs(mouseOffsetX - canvasOffsetX);
        var divY = Math.abs(mouseOffsetY - canvasOffsetY);
        console.log("div: (" + divX + ", " + divY + ")");
      });*/


      var databaseView = this;

      var visibleTop;
      var visibleLeft;
      var mousedown = false;
      $(this).find('.minimap .visible-area').on('mousedown', function() {
        $(this).addClass('cursor-webkit-grabbing');

        mousedown = true;
        databaseView.xDragScreen = event.pageX - $(this).parent().offset().left;
        databaseView.yDragScreen = event.pageY - $(this).parent().offset().top;

        visibleTop = $(this).position().top;
        visibleLeft = $(this).position().left;
        console.log("visibleTop: " + visibleTop);
        console.log("visibleLeft: " + visibleLeft);
      });
      $(this).find('.minimap .visible-area').on('mousemove', function() {
        if (mousedown) {
          // find current location on screen
          var xScreen = event.pageX - $(this).parent().offset().left;
          var yScreen = event.pageY - $(this).parent().offset().top;

          console.log("$(this).width(): " + $(this).width());
          console.log("$(this).height(): " + $(this).height());

          //databaseView.xNew2 = databaseView.xNew + (xScreen - databaseView.xDragScreen) / databaseView.getScale();
          //databaseView.yNew2 = databaseView.yNew + (yScreen - databaseView.yDragScreen) / databaseView.getScale();

          databaseView.xNew2 = databaseView.xNew - (xScreen - databaseView.xDragScreen) * databaseView.widthMinimap / 150;
          databaseView.yNew2 = databaseView.yNew - (yScreen - databaseView.yDragScreen) * databaseView.widthMinimap / 150;

          $(this).css({top: visibleTop + (yScreen - databaseView.yDragScreen),
                     left: visibleLeft + (xScreen - databaseView.xDragScreen) });

          console.log("top: " + (xScreen - databaseView.xDragScreen));
          console.log("left: " + (yScreen - databaseView.yDragScreen));

       //   visibleTop = visibleTop + databaseView.yNew2;
       //   visibleLeft = visibleLeft + databaseView.xNew2;

          $(databaseView).find('.database-visualizer-canvas')
                  .css('transform', 'scale(' + databaseView.getScale() + ')' + 'translate(' + databaseView.xNew2 + 'px, ' + databaseView.yNew2 + 'px' + ')');
        }
      });
      var mouseUpOrLeave = function() {
        if (mousedown) {
          mousedown = false;
          $(this).removeClass('cursor-webkit-grabbing');
          databaseView.xDiffNew = databaseView.xDiffNew + databaseView.xNew2 - databaseView.xNew;
          databaseView.yDiffNew = databaseView.yDiffNew + databaseView.yNew2 - databaseView.yNew;
          databaseView.xNew = databaseView.xNew2;
          databaseView.yNew = databaseView.yNew2;
        }
      };
      $(this).find('.minimap .visible-area').on('mouseup', mouseUpOrLeave);
      $(this).find('.minimap').on('mouseleave', mouseUpOrLeave);






      var xImage = 0; // last x location on the image
      var yImage = 0; // last y location on the image
      var xLast = 0;  // last x location on the screen
      var yLast = 0;  // last y location on the screen

      $(this).bind('mousewheel', function(event, delta) {
        // find current location on screen
        var xScreen = event.pageX - $(this).offset().left;
        var yScreen = event.pageY - $(this).offset().top;

        // find current location on the image at the current scale
        xImage = xImage + ((xScreen - xLast) / this.getScale());
        yImage = yImage + ((yScreen - yLast) / this.getScale());

        // determine the new scale
        let scale = this.getScale() *  (1 + delta / 100);
        if (scale < 0.05) {
          scale = 0.05;
        } else if (scale > 3) {
          scale = 3;
        }


        // determine the location on the screen at the new scale
        this.xNew = (xScreen - xImage) / scale + this.xDiffNew;
        this.yNew = (yScreen - yImage) / scale + this.yDiffNew;

        // save the current screen location
        xLast = xScreen;
        yLast = yScreen;

        // redraw

          this.setScale(scale);
          $(this).find('.database-visualizer-canvas')
                  .css('transform', 'scale(' + scale + ')' + 'translate(' + this.xNew + 'px, ' + this.yNew + 'px' + ')')
                  .css('transform-origin', xImage + 'px ' + yImage + 'px');

        this.refreshMinimapZoom();
        return false;
      });

      var databaseViewMouseDown = function(event) {
        databaseView.dragging = (event.target === databaseView || event.target === $(databaseView).find('.database-visualizer-canvas')[0] || event.target === $(databaseView).children('h1')[0]);
        if (databaseView.dragging) {
          $(databaseView).addClass('cursor-webkit-grabbing');
          $(databaseView).find('.database-visualizer-canvas').addClass('cursor-webkit-grabbing');

          databaseView.xDragScreen = event.pageX - $(databaseView).offset().left;
          databaseView.yDragScreen = event.pageY - $(databaseView).offset().top;
        }
      };

      var databaseViewMouseMove = function(event) {
        if (!databaseView.draggingChild && databaseView.dragging) {

          // find current location on screen
          var xScreen = event.pageX - $(databaseView).offset().left;
          var yScreen = event.pageY - $(databaseView).offset().top;

          databaseView.xNew2 = databaseView.xNew + (xScreen - databaseView.xDragScreen) / databaseView.getScale();
          databaseView.yNew2 = databaseView.yNew + (yScreen - databaseView.yDragScreen) / databaseView.getScale();

          $(databaseView).find('.database-visualizer-canvas')
                  .css('transform', 'scale(' + databaseView.getScale() + ')' + 'translate(' + databaseView.xNew2 + 'px, ' + databaseView.yNew2 + 'px' + ')');

          this.refreshMinimapZoom();
        }

        return true;
      };
      var databaseViewMouseUp = function(event) {
        if (databaseView.dragging) {
          $(databaseView).removeClass('cursor-webkit-grabbing');
          $(databaseView).find('.database-visualizer-canvas').removeClass('cursor-webkit-grabbing');
          databaseView.xDiffNew = databaseView.xDiffNew + databaseView.xNew2 - databaseView.xNew;
          databaseView.yDiffNew = databaseView.yDiffNew + databaseView.yNew2 - databaseView.yNew;
          databaseView.xNew = databaseView.xNew2;
          databaseView.yNew = databaseView.yNew2;
          databaseView.dragging = false;
        }
      };

      $(this).bind('mousedown', databaseViewMouseDown);
      $(this).bind('mousemove', databaseViewMouseMove);
      $(this).bind('mouseup', databaseViewMouseUp);

      setTimeout(function() {
        databaseView.refresh();
      }, 200);

    },


    detached: function() {
      // The analog to `attached`, `detached` fires when the element has been
      // removed from a document.
      //
      // Use this to clean up anything you did in `attached`.
    },

    // Element Behavior

    /**
     * The `database-visualizer-lasers` event is fired whenever `fireLasers` is called.
     *
     * @event database-visualizer-lasers
     * @detail {{sound: String}}
     */

    /**
     * Sometimes it's just nice to say hi.
     *
     * @param {string} greeting A positive greeting.
     * @return {string} The full greeting.
     */
    sayHello: function(greeting) {
      var response = greeting || 'Hello World!';
      return 'database-visualizer says, ' + response;
    },

    /**
     * Attempts to destroy this element's enemies with an any beam of light!
     *
     * Or, at least, dispatches an event in the vain hope that someone else will
     * do the zapping.
     */
    fireLasers: function() {
      this.fire('database-visualizer-lasers', {sound: 'Pew pew!'});
    }

  });

</script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-mousewheel/3.1.13/jquery.mousewheel.js"></script>
<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/themes/smoothness/jquery-ui.css">
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>

