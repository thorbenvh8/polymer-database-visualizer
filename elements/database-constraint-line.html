<!DOCTYPE html>
<html>
<head>
    <!-- Element Imports -->
</head>

<dom-module id="database-constraint-line">
    <style>
        /* CSS rules for your element */
        :host {
            cursor: pointer;
        }
    </style>
    <template>
        <svg>
            <image class="backup" width="17" height="17" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAARCAYAAAA7bUf6AAAACXBIWXMAAAsTAAALEwEAmpwYAAABLUlEQVQ4y61US4rCQBBNeojiRrLSnbMOWWU3V1FPouARcgc9hyLOCSSbYZw5gRCIkM9KbevJaycS4zCOBY+iq6pf1y+xrNtiE6oEY/tVzMUXgSNoCJrUDu3qHpldutwSuIKOoEvt0m7I7DoCvNj2fb8XRdEojuN5lmVraJxhh59xFSLFF9phGL7lef6hRb63R73aHM8aAjv8JHJ47yqLlud5r0VRbHa51sPZQVuT/QU4ww4/4ljaJRubrC5SxouD6TWBQV/sEIkbs0eOIVGssSO1L5D6LQID+BHHZjdMSYpj7KZpun7/uk8CP5rNqTXLJP/OpNyTMWruP9CTP08nCILKdCp7gkCzJ8vPnz2BvW5PKhuLjJBykiQLaWIEjTP3o3Zjn/LtPO0rfvh/cgKu7z6wtPPltQAAAABJRU5ErkJggg==" preserveAspectRatio="none"></image>
            <path class="transparent-outline" d="M 1333 578 L 1553.01 568.43 Q 1563 568 1570.35 561.22 L 1685.65 454.78 Q 1693 448 1701.94 452.47 L 1804.06 503.53 Q 1813 508 1807.09 516.06 L 1706.77 652.86"></path>
            <path class="line" d="M 1333 578 L 1553.01 568.43 Q 1563 568 1570.35 561.22 L 1685.65 454.78 Q 1693 448 1701.94 452.47 L 1804.06 503.53 Q 1813 508 1807.09 516.06 L 1706.77 652.86"></path>
        </svg>
    </template>
</dom-module>
<script>
    Polymer({
        is: "database-constraint-line",
        listeners: {
            'track': '_handleTrack'
        },
        properties: {
            constraint: {
                type: Object,
                notify: true,
                value: function() {
                    return {
                        name: "name",
                        schema: "schema1",
                        table: "table1",
                        columns: ["column1"],
                        rschema: "schema1",
                        rtable: "table2",
                        rcolumns: ["column1"],
                        positions: []
                    };
                }
            },
            _paths: {
                type: Array,
                notify: true,
                value: function() {
                    return [];
                }
            },
            _rTable: {
                type: Object,
                notify: true,
                value: function() {
                    return {
                        table: null,
                        columns: [],
                        column_pos: null,
                        column_height: null,
                        connector: ""
                    };
                }
            },
            _table: {
                type: Object,
                notify: true,
                value: function() {
                    return {
                        table: {},
                        columns: [],
                        column_pos: null,
                        column_height: null,
                        connector: ""
                    };
                }
            },
            _selected: {
                type: Boolean,
                value: false,
                observer: "observerSelected"
            },
            /*_points: {
                type: Array,
                value: []
            }*/
        },

        ready: function() {

        },

        attached: function() {
            console.log("positions: ");
            console.log(this.constraint.positions);

            var databaseConstraintLine = this;

            $(this).children('svg').children('image.point').remove();
            this._points = [];
            $.each(this.constraint.positions, function() {
                databaseConstraintLine.drawPoint(this.position);
            });

            /** save SVG variables **/
            this._paths = $(this).children('svg').children('path');

            /** save tables **/
            //TODO make specific to this polymer object
            this._table.table = $('database-table#'+this.constraint.schema+"_"+this.constraint.table)[0];
            this._table.table.registerConstraint(this);

            /** highlight on mouseenter **/
            $(this).mouseenter(function() {
                databaseConstraintLine.highlight(true);
                databaseConstraintLine.highlightColumn(true, this.table);
            });
            /** dehighlight on mouseleave **/
            $(this).mouseleave(function() {
                databaseConstraintLine.highlight(false);
                databaseConstraintLine.highlightColumn(false, this.table);
            });

            $(this).click(function() {
                this.select();
            });
        },

        _handleTrack: function(e) {
            console.log(e.detail.state);

            //console.log(e.target.className);
            if (e.target.tagName === "image") {

                switch (e.detail.state) {
                    case 'start':
                        // Capture initial state
                        this.dragEl = e.target;
                        this.dragEl.style.pointerEvents = 'none';
                        this.dragEl.classList.add('dragging');
                        this.startX = parseFloat($(this.dragEl).attr('x'));
                        this.startY = parseFloat($(this.dragEl).attr('y'));
                        //this.dragModel = this.repeater.modelForElement(this.dragEl);
                        break;
                    case 'track':
                        // Re-position dragged item
                        this.updateDragPosition(e.detail.dx, e.detail.dy);
                        this.refresh();
                        // Translate non-dragged items up/down
                        /*
                    var overEl = e.detail.hover();
                    var overModel = overEl && this.repeater.modelForElement(overEl);
                    if (overModel) {
                        this.overModel = overModel;
                        this.dirOffset = e.detail.ddy < 0 ? -1 : 0;
                        var lastOverIndex = this.overIndex || 0;
                        var overIndex = overModel.index + this.dirOffset;
                        var start = Math.max(overIndex < lastOverIndex ? overIndex : lastOverIndex, 0);
                        var end = overModel.index < lastOverIndex ? lastOverIndex : overModel.index;
                        var children = Polymer.dom(this).children;
                        for (var i=start; i<=end; i++) {
                            var el = children[i];
                            if (el != this.repeater && i !== this.dragModel.index) {
                                var dir = 0;
                                if (i > this.dragModel.index && i <= overIndex) {
                                    dir = -1;
                                } else if (i > overIndex && i < this.dragModel.index) {
                                    dir = 1;
                                }
                                el.classList.add('moving');
                                this.translate3d(0, dir * this.dragEl.offsetHeight + 'px', 0, el);
                            }
                        }
                        this.overIndex = overModel.index;
                    }
                    */
                    break;
                case 'end':
                    // Move item in array to new position
                    /*
                    var fromIdx = this.repeater.items.indexOf(this.dragModel.item);
                    if (fromIdx >= 0 && this.overModel) {
                        var toIdx = this.repeater.items.indexOf(this.overModel.item) +
                                (this.overModel.index > this.dragModel.index ? this.dirOffset : 0);
                        var item = this.repeater.splice('items', fromIdx, 1)[0];
                        this.repeater.splice('items', toIdx, 0, item);
                    }
                    // Reset style of dragged & moved elements
                    Polymer.dom(this).children.forEach(function(el) {
                        this.transform('', el);
                        el.classList.remove('moving');
                    }, this);*/
                    this.dragEl.style.pointerEvents = '';
                    this.dragEl.classList.remove('dragging');
                    this.dragEl = null;

                    break;
                }
            }
        },

        getScale() {
            return this._table.table.getScale();
        },

        updateDragPosition: function(dx, dy) {
            this.trackDeltaLeft = dx || this.trackDeltaLeft || 0;
            this.trackDeltaTop = dy || this.trackDeltaTop || 0;
            var posX = this.startX + this.trackDeltaLeft / this.getScale();
            var posY = this.startY + this.trackDeltaTop / this.getScale();
            $(this.dragEl).attr({ x: posX, y: posY});
        },

        refresh() {
            if (this._rTable.table === null) {
                this._rTable.table = $('database-table#'+this.constraint.rschema+"_"+this.constraint.rtable)[0];
                this._rTable.table.registerConstraint(this);
            }

            var tablePos = this._table.table.getPosition();
            var rTablePos = this._rTable.table.getPosition();

            // TODO calculate each time individual?!
            var diffX = this._table.column_height * 8/3;
            var diffY = this._table.column_height * 4/5;
            var diffBroomX = this._table.column_height * 5/3;

            $(this).children('svg').children('image.point.middle').remove();

            if (this._table.connector === "" &&  this._rTable.connector === "") {
                /** table <-> rTable **/
                if (tablePos.left < rTablePos.left) {
                    this._table.connector = "left";
                    this._rTable.connector = "right";
                }
                /** rTable <-> table **/
                else {
                    this._rTable.connector = "left";
                    this._table.connector = "right";
                }
            }

            var pathRPos;
            var d;
            if (this._rTable.connector === "left") {
                pathRPos = this._getRTablePathRPosLeft(rTablePos, diffX);
                d = this._getRTableDLeft(pathRPos, rTablePos, diffY, diffBroomX);
            }
            if (this._rTable.connector === "right") {
                pathRPos = this._getRTablePathRPosRight(rTablePos, diffX);
                d = this._getRTableDRight(pathRPos, rTablePos, diffY, diffBroomX);
            }

            var line = this;
            var lastPoint = pathRPos;
            $.each(this._points, function(index) {
                console.log("index: " + index);
                //{ x: point.x + 17/2, y: point.y + 17/2}
                var p = {
                    x: parseFloat($(this).attr('x')) + 17/2,
                    y: parseFloat($(this).attr('y')) + 17/2
                };
                d = d + " L " + p.x + " " + p.y;
                //line.drawPoint(p);
                line.drawMiddlePoint(lastPoint, p, index);

                lastPoint = p;
            });

            var pathPos;
            if (this._table.connector === "left") {
                pathPos = this._getTablePathPosLeft(tablePos, diffX);
                d = d + this._getTableDLeft(pathPos, tablePos);
            }
            if (this._table.connector === "right") {
                pathPos = this._getTablePathPosRight(tablePos, diffX);
                d = d + this._getTableDRight(pathPos, tablePos);
            }

            this.drawMiddlePoint(lastPoint, pathPos, this._points.length);

            $.each(this._paths, function() {
                $(this).attr({d: d});
            });
        },

        _getRTablePathRPosRight(rTablePos, diffX) {
            return {
                x: (rTablePos.left - diffX),
                y: (rTablePos.top + this._rTable.column_pos.top + this._rTable.column_height)
            };
        },
        _getRTablePathRPosLeft(rTablePos, diffX) {
            return {
                x: (rTablePos.left + rTablePos.width + diffX),
                y: (rTablePos.top + this._rTable.column_pos.top + this._rTable.column_height)
            };
        },
        _getTablePathPosLeft(tablePos, diffX) {
            return {
                x: (tablePos.left + tablePos.width + diffX),
                y: (tablePos.top + this._table.column_pos.top + this._table.column_height)
            };
        },
        _getTablePathPosRight(tablePos, diffX) {
            return {
                x: (tablePos.left - diffX),
                y: (tablePos.top + this._table.column_pos.top + this._table.column_height)
            };
        },
        _getRTableDRight(pathRPos, rTablePos, diffY, diffBroomX) {
            var d = "M " + (rTablePos.left) + " " + (rTablePos.top + this._rTable.column_pos.top + this._rTable.column_height + diffY);
            d = d + " L " + (rTablePos.left - 1) + " " + (rTablePos.top + this._rTable.column_pos.top + this._rTable.column_height + diffY);
            d = d + " L " + (rTablePos.left - diffBroomX) + " " + (rTablePos.top + this._rTable.column_pos.top + this._table.column_height);
            d = d + " L " + (rTablePos.left - 1) + " " + (rTablePos.top + this._rTable.column_pos.top + this._rTable.column_height - diffY);
            d = d + " L " + (rTablePos.left) + " " + (rTablePos.top + this._rTable.column_pos.top + this._rTable.column_height - diffY);
            d = d + " L " + (rTablePos.left - 1) + " " + (rTablePos.top + this._rTable.column_pos.top + this._rTable.column_height - diffY);
            d = d + " L " + (rTablePos.left - diffBroomX) + " " + (rTablePos.top + this._rTable.column_pos.top + this._table.column_height);
            d = d + " L " + (rTablePos.left) + " " + (rTablePos.top + this._rTable.column_pos.top + this._rTable.column_height);
            d = d + " L " + pathRPos.x + " " + pathRPos.y;
            return d;
        },
        _getRTableDLeft(pathRPos, rTablePos, diffY, diffBroomX) {
            var d = "M " + (rTablePos.left + rTablePos.width) + " " + (rTablePos.top + this._rTable.column_pos.top + this._rTable.column_height + diffY);
            d = d + " L " + (rTablePos.left + rTablePos.width + 1) + " " + (rTablePos.top + this._rTable.column_pos.top + this._rTable.column_height + diffY);
            d = d + " L " + (rTablePos.left + rTablePos.width + diffBroomX) + " " + (rTablePos.top + this._rTable.column_pos.top + this._table.column_height);
            d = d + " L " + (rTablePos.left + rTablePos.width + 1) + " " + (rTablePos.top + this._rTable.column_pos.top + this._rTable.column_height - diffY);
            d = d + " L " + (rTablePos.left + rTablePos.width) + " " + (rTablePos.top + this._rTable.column_pos.top + this._rTable.column_height - diffY);
            d = d + " L " + (rTablePos.left + rTablePos.width + 1) + " " + (rTablePos.top + this._rTable.column_pos.top + this._rTable.column_height - diffY);
            d = d + " L " + (rTablePos.left + rTablePos.width + diffBroomX) + " " + (rTablePos.top + this._rTable.column_pos.top + this._table.column_height);
            d = d + " L " + (rTablePos.left + rTablePos.width) + " " + (rTablePos.top + this._rTable.column_pos.top + this._rTable.column_height);
            d = d + " L " + pathRPos.x + " " + pathRPos.y;
            return d;
        },
        _getTableDLeft(pathPos, tablePos) {
            var d = " L " + pathPos.x+ " " + pathPos.y;
            d = d + " L " + (tablePos.left + tablePos.width) + " " + (tablePos.top + this._table.column_pos.top + this._table.column_height);
            return d;
        },
        _getTableDRight(pathPos, tablePos) {
            var d = " L " + pathPos.x + " " + pathPos.y;
            d = d + " L " + (tablePos.left) + " " + (tablePos.top + this._table.column_pos.top + this._table.column_height);
            return d;
        },

        drawMiddlePoint(point1, point2, index) {
            console.log("index: " + index);
            let constraintLine = this;
            let point = {
                x: (point1.x + (point2.x - point1.x)/2 - (17 / 2)),
                y: (point1.y + (point2.y - point1.y)/2 - (17 / 2))
            };

            var image = $(this).children('svg').children('image.backup')
                    .clone()
                    .removeClass('backup')
                    .addClass('point middle')
                    .attr(point)
                    .on('drag', function() {
                        console.log("DRAGGING HIER");
                    })
                    .on('mousedown', function() {
                        console.log("index: " + index);
                        console.log(constraintLine._points);
                        $(this).removeClass('middle');
                        constraintLine._points.splice(index, 0, this);
                        constraintLine.refresh();
                        console.log(constraintLine._points);
                        $(this).off('mousedown');

                        $(this).on('dblclick', function() {
                            var index = constraintLine._points.indexOf(this);
                            if (index > -1) {
                                constraintLine._points.splice(index, 1);
                                $(this).remove();
                            }
                            constraintLine.refresh();
                        })
                    });
            $(this).children('svg').append(image);
        },
        drawPoint(point) {
            var constraintLine = this;

            var image = $(this).children('svg').children('image.backup')
                    .clone()
                    .removeClass('backup')
                    .addClass('point')
                    .attr({
                        x: point.x - (17 / 2),
                        y: point.y - (17 / 2)
                    })
                    .on('dblclick', function() {
                        var index = constraintLine._points.indexOf(this);
                        if (index > -1) {
                            constraintLine._points.splice(index, 1);
                        }
                    });
            $(this).children('svg').append(image);

            this._points.push(image);
        },

        observerSelected(value) {
            if (value) {
                $(this).addClass("selected-constraint");
            } else {
                $(this).removeClass("selected-constraint");
            }
        },
        select() {
            let constraintLine = this;
            $.each($('database-constraint-line'), function() {
                if (this !== constraintLine) {
                    this.deselect();
                }
            });

            this._selected = true;

            this._table.columns[0].constraintSelected(this._table.connector, this, "table");
            this._rTable.columns[0].constraintSelected(this._rTable.connector, this, "rTable");
        },
        switchConnector(table) {
            if (table === "table") {
                this._table.connector = this._table.connector === "left" ? "right" : "left";
            } else {
                this._rTable.connector = this._rTable.connector === "left" ? "right" : "left";
            }
            this.refresh();
        },
        deselect() {
            this._selected = false;

            this._rTable.columns[0].constraintDeselected();
            this._table.columns[0].constraintDeselected();
        },

        highlight(bool) {
            if (bool) {
                $(this).addClass('highlight');
            } else {
                if (!this._table.table.selected && !this._rTable.table.selected) {
                    $(this).removeClass('highlight');
                }
            }
        },
        highlightColumn(bool) {
            if (bool) {
                $.each(this._table.columns, function() {
                    $(this).addClass('highlight');
                });
                $.each(this._rTable.columns, function() {
                    $(this).addClass('highlight');
                });
            } else {
                $.each(this._table.columns, function() {
                    $(this).removeClass('highlight');
                });
                $.each(this._rTable.columns, function() {
                    $(this).removeClass('highlight');
                });
            }
        },
        registerColumn(columns) {
            var constraintLine = this;
            $.each(columns, function() {
                /*
                name: "name",
                schema: "schema1",
                table: "table1",
                columns: ["column1"],
                rschema: "schema1",
                rtable: "table2",
                rcolumns: ["column1"]
                */
                var column = this;
                $.each(constraintLine.constraint.columns, function() {
                    var id = constraintLine.constraint.schema + "_" + constraintLine.constraint.table + "_" + this;
                    if (id === $(column).attr('id')) {
                        constraintLine._table.columns.push(column);
                    }
                });

                $.each(constraintLine.constraint.rcolumns, function() {
                    var id = constraintLine.constraint.rschema + "_" + constraintLine.constraint.rtable + "_" + this;
                    if (id === $(column).attr('id')) {
                        constraintLine._rTable.columns.push(column);
                    }
                });
            });

            /** save columns positions in the table **/
            this._table.column_pos = this._table.columns[0].getPosition();
            this._table.column_height = $(this._table.columns[0]).height() / 2;
            if (this._rTable.columns.length > 0) {
                this._rTable.column_pos = this._rTable.columns[0].getPosition();
                this._rTable.column_height = $(this._rTable.columns[0]).height() / 2;
            }
        }
    });
</script>
</html>
