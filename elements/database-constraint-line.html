<!DOCTYPE html>
<html>
<head>
    <!-- Element Imports -->
</head>

<dom-module id="database-constraint-line">
    <style>
        /* CSS rules for your element */
    </style>
    <template>
        <svg>
            <line class="r-broom-top"></line>
            <line class="r-broom-middle"></line>
            <line class="r-broom-bottom"></line>
            <line class="changeable"/>
            <line class="broom-middle"></line>
        </svg>
    </template>
</dom-module>
<script>
    Polymer({
        is: "database-constraint-line",
        properties: {
            constraint: {
                type: Object,
                notify: true,
                value: function() {
                    return {
                        name: "name",
                        schema: "schema1",
                        table: "table1",
                        columns: ["column1"],
                        rschema: "schema1",
                        rtable: "table2",
                        rcolumns: ["column1"]
                    };
                }
            },
            _line: {
                type: Object,
                notify: true,
                value: function() {
                    return {};
                }
            },
            _rTable: {
                type: Object,
                notify: true,
                value: function() {
                    return {
                        table: null,
                        broom: {
                            top: {},
                            middle: {},
                            bottom: {}
                        },
                        columns: [],
                        column_pos: null,
                        column_height: null
                    };
                }
            },
            _table: {
                type: Object,
                notify: true,
                value: function() {
                    return {
                        table: {},
                        broom: {
                            middle: {}
                        },
                        columns: [],
                        column_pos: null,
                        column_height: null
                    };
                }
            }
        },

        ready: function() {

        },

        attached: function() {
            /** save SVG variables **/
            this._line = $(this).children('svg').children('.changeable')[0];

            this._rTable.broom.top = $(this).children('svg').children('.r-broom-top')[0];
            this._rTable.broom.middle = $(this).children('svg').children('.r-broom-middle')[0];
            this._rTable.broom.bottom = $(this).children('svg').children('.r-broom-bottom')[0];

            this._table.broom.middle = $(this).children('svg').children('.broom-middle')[0];

            /** save tables **/
            //TODO make specific to this polymer object
            this._table.table = $('database-table#'+this.constraint.schema+"_"+this.constraint.table)[0];
            this._table.table.registerConstraint(this);

            var databaseConstraintLine = this;
            /** highlight on mouseenter **/
            $(this).mouseenter(function() {
                databaseConstraintLine.highlight(true);
                databaseConstraintLine.highlightColumn(true, this.table);
            });
            /** dehighlight on mouseleave **/
            $(this).mouseleave(function() {
                databaseConstraintLine.highlight(false);
                databaseConstraintLine.highlightColumn(false, this.table);
            });
        },
        refresh() {
            if (this._rTable.table === null) {
                this._rTable.table = $('database-table#'+this.constraint.rschema+"_"+this.constraint.rtable)[0];
                this._rTable.table.registerConstraint(this);
            }

            var tablePos = this._table.table.getPosition();
            var rTablePos = this._rTable.table.getPosition();

            // TODO calculate each time individual?!
            var diffX = this._table.column_height * 8/3;
            var diffY = this._table.column_height * 4/5;
            var diffBroomX = this._table.column_height * 5/3;

            /** table <-> rTable **/
            if (tablePos.left < rTablePos.left) {
                $(this._line).attr('x1',tablePos.left + tablePos.width + diffX).attr('y1',tablePos.top + this._table.column_pos.top + this._table.column_height).attr('x2',rTablePos.left - diffX).attr('y2',rTablePos.top + this._rTable.column_pos.top + this._rTable.column_height);

                $(this._rTable.broom.top).attr('x1',rTablePos.left).attr('y1',rTablePos.top + this._rTable.column_pos.top + this._rTable.column_height - diffY).attr('x2',rTablePos.left - diffBroomX).attr('y2',rTablePos.top + this._rTable.column_pos.top + this._table.column_height);
                $(this._rTable.broom.middle).attr('x1',rTablePos.left).attr('y1',rTablePos.top + this._rTable.column_pos.top + this._rTable.column_height).attr('x2',rTablePos.left - diffX).attr('y2',rTablePos.top + this._rTable.column_pos.top + this._table.column_height);
                $(this._rTable.broom.bottom).attr('x1',rTablePos.left).attr('y1',rTablePos.top + this._rTable.column_pos.top + this._rTable.column_height + diffY).attr('x2',rTablePos.left - diffBroomX).attr('y2',rTablePos.top + this._rTable.column_pos.top + this._table.column_height);

                $(this._table.broom.middle).attr('x1',tablePos.left + tablePos.width).attr('y1',tablePos.top + this._table.column_pos.top + this._table.column_height).attr('x2',tablePos.left + tablePos.width + diffX).attr('y2',tablePos.top + this._table.column_pos.top + this._table.column_height);
            }
            /** rTable <-> table **/
            else {
                $(this._line).attr('x1',tablePos.left - diffX).attr('y1',tablePos.top + this._table.column_pos.top + this._table.column_height).attr('x2',rTablePos.left + rTablePos.width + diffX).attr('y2',rTablePos.top + this._rTable.column_pos.top + this._rTable.column_height);

                $(this._rTable.broom.top).attr('x1',rTablePos.left + rTablePos.width).attr('y1',rTablePos.top + this._rTable.column_pos.top + this._rTable.column_height - diffY).attr('x2',rTablePos.left + rTablePos.width + diffBroomX).attr('y2',rTablePos.top + this._rTable.column_pos.top + this._table.column_height);
                $(this._rTable.broom.middle).attr('x1',rTablePos.left + rTablePos.width).attr('y1',rTablePos.top + this._rTable.column_pos.top + this._rTable.column_height).attr('x2',rTablePos.left + rTablePos.width + diffX).attr('y2',rTablePos.top + this._rTable.column_pos.top + this._table.column_height);
                $(this._rTable.broom.bottom).attr('x1',rTablePos.left + rTablePos.width).attr('y1',rTablePos.top + this._rTable.column_pos.top + this._rTable.column_height + diffY).attr('x2',rTablePos.left + rTablePos.width + diffBroomX).attr('y2',rTablePos.top + this._rTable.column_pos.top + this._table.column_height);

                $(this._table.broom.middle).attr('x1',tablePos.left).attr('y1',tablePos.top + this._table.column_pos.top + this._table.column_height).attr('x2',tablePos.left - diffX).attr('y2',tablePos.top + this._table.column_pos.top + this._table.column_height);
            }
        },
        highlight(bool) {
            if (bool) {
                $(this).addClass('highlight');
            } else {
                if (!this._table.table.selected && !this._rTable.table.selected) {
                    $(this).removeClass('highlight');
                }
            }
        },
        highlightColumn(bool) {
            if (bool) {
                $.each(this._table.columns, function() {
                    $(this).addClass('highlight');
                });
                $.each(this._rTable.columns, function() {
                    $(this).addClass('highlight');
                });
            } else {
                $.each(this._table.columns, function() {
                    $(this).removeClass('highlight');
                });
                $.each(this._rTable.columns, function() {
                    $(this).removeClass('highlight');
                });
            }
        },
        registerColumn(columns) {
            var constraintLine = this;
            $.each(columns, function() {
                /*
                name: "name",
                schema: "schema1",
                table: "table1",
                columns: ["column1"],
                rschema: "schema1",
                rtable: "table2",
                rcolumns: ["column1"]
                */
                var column = this;
                $.each(constraintLine.constraint.columns, function() {
                    var id = constraintLine.constraint.schema + "_" + constraintLine.constraint.table + "_" + this;
                    if (id === $(column).attr('id')) {
                        constraintLine._table.columns.push(column);
                    }
                });

                $.each(constraintLine.constraint.rcolumns, function() {
                    var id = constraintLine.constraint.rschema + "_" + constraintLine.constraint.rtable + "_" + this;
                    if (id === $(column).attr('id')) {
                        constraintLine._rTable.columns.push(column);
                    }
                });
            });

            console.log("registerColumn");
            /** save columns positions in the table **/
            this._table.column_pos = this._table.columns[0].getPosition();
            this._table.column_height = $(this._table.columns[0]).height() / 2;
            if (this._rTable.columns.length > 0) {
                this._rTable.column_pos = this._rTable.columns[0].getPosition();
                this._rTable.column_height = $(this._rTable.columns[0]).height() / 2;
            }
        }
    });
</script>
</html>
