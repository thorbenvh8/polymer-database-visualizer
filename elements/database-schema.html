<!DOCTYPE html>
<html>
<head>
    <link href="database-table.html" rel="import">
    <!-- Element Imports -->
</head>

<dom-module id="database-schema">
    <style>
        :host {
            margin: 0 0 20px;
            position: relative;
            left: 20px;
            top: 20px;
        }

    </style>
    <template>
        <div class="database-visualizer-div-header background-color-primary">
            <h2>{{schema.name}}</h2>
        </div>
        <template is="dom-repeat" items="{{schema.tables}}">
            <database-table id="{{schema.name}}_{{item.name}}" schemaname="{{schema.name}}" table="{{item}}"></database-table>
        </template>
    </template>
</dom-module>
<script>
    Polymer({
                is: "database-schema",
                properties: {
                    schema: {
                        type: Object,
                        notify: true,
                        value: function() {
                            return {
                                name: "schema1",
                                tables:  [{name: "table1"}],
                                left: 400
                            };
                        }
                    },
                    _visualizer: {
                        type: Object,
                        notify: true,
                        value: function() {
                            return {};
                        }
                    },
                    _tables: {
                        type: Array,
                        notify: true,
                        value: function() {
                            return [];
                        }
                    },
                    _left: Number,
                    _top: Number,
                    _width: Number,
                    _height: Number,
                    _headerHeight: Number,
                    _calcWidth: Number,
                    _calcLeft: Number,
                    _calcTop: Number,
                    _calcHeight: Number
                },

                registerTable(table) {
                    this._tables.push(table);

                    if (this.schema.tables.length === this._tables.length) {
                        this._visualizer.registerSchema(this);
                    }

                },

                getScale() {
                    return this._visualizer.getScale();
                },

                getTables() {
                    return this._tables;
                },

                refresh() {
                    $.each(this._tables, function() {
                        this.refresh();
                    });
                },

                setTop(top) {
                    this._top = top;
                    $(this).css({top: this._top});
                },
                getTop() {
                    return this._top;
                },

                setHeight(height) {
                    this._height = height;
                    $(this).css({height: this._height});
                },
                getHeight() {
                    return this._height;
                },

                setLeft(left) {
                    this._left = left;
                    $(this).css({left: this._left});
                },
                getLeft() {
                    return this._left;
                },

                setWidth(width) {
                    this._width = width;
                    $(this).css({width: this._width});
                },
                getWidth() {
                    return this._width;
                },

                setHeaderHeight(headerHeight) {
                    this._headerHeight = headerHeight;
                },
                getHeaderHeight() {
                    return this._headerHeight;
                },

                setDraggingChild(b) {
                    this._visualizer.setDraggingChild(b);
                },
                calcWidth(changeWidth) {
                    this._calcWidth = this._width + changeWidth;
                    $(this).css({width: this._calcWidth});
                },
                setCalcWidth() {
                    if (!isNaN(this._calcWidth) && this._width < this._calcWidth) {
                        this._width = this._calcWidth;
                    }
                },
                calcLeft(changeLeft) {
                    this._calcLeft = this._left - changeLeft;
                    $(this).css({left: this._calcLeft});
                },
                setCalcLeft() {
                    if (!isNaN(this._calcLeft)) {
                        this._left = this._calcLeft;
                    }
                },
                calcHeight(changeHeight) {
                    this._calcHeight = this._height + changeHeight;
                    $(this).css({height: this._calcHeight});
                },
                setCalcHeight() {
                    if (!isNaN(this._calcHeight) && this._height < this._calcHeight) {
                        this._height = this._calcHeight;
                    }
                },
                calcTop(changeTop) {
                    this._calcTop = this._top - changeTop;
                    $(this).css({top: this._calcTop});
                },
                setCalcTop() {
                    if (!isNaN(this._calcTop)) {
                        this._top = this._calcTop;
                    }
                },

                refreshMinimap() {
                    this._visualizer.refreshMinimap();
                },

                ready: function() {

                },

                attached: function() {
                    console.log("attachted schema: " + this.schema.name);

                    this._visualizer = $(this).parent().parent('database-visualizer-database')[0];

                    this._left = this.schema.left;
                    this._top = this.schema.top;
                    this._width = this.schema.width;
                    this._height = this.schema.height;

                    this.setHeaderHeight($(this).children('.database-visualizer-div-header').height());

                    $(this).css({
                        left: this._left,
                        top: this._top,
                        width: this._width,
                        height: this._height
                    });

                    $(this).draggable({
                        //TODO drag only on header
                        //handle: "> .database-visualizer-div-header",
                        start: function(event, ui) {
                            ui.position.left = 0;
                            ui.position.top = 0;
                            this.setDraggingChild(true);
                        },
                        drag: function(event, ui) {
                            ui.position.left = getNewLeft(ui, this.getScale());
                            ui.position.top = getNewTop(ui, this.getScale());

                            this.refresh();
                        },
                        stop: function(event, ui) {
                            // TODO make short and beautiful
                            var changeLeft = ui.position.left - ui.originalPosition.left; // find change in left
                            var newLeft = ui.originalPosition.left + changeLeft / this.getScale(); // adjust new left by our zoomScale

                            var changeTop = ui.position.top - ui.originalPosition.top; // find change in top
                            var newTop = ui.originalPosition.top + changeTop / this.getScale(); // adjust new top by our zoomScale

                            this._left = newLeft * this.getScale();
                            this._top = newTop * this.getScale();

                            this.refresh();
                            this._visualizer.refreshMinimap();
                            this.setDraggingChild(false);

                            this._visualizer.fireSchemaDraggedOrResized(this.schema.id, this._left, this._top, this._width, this._height);
                        }
                    });

                    $(this).mouseenter(function() {
                        $(this).addClass("draggable");
                    });
                    $(this).mouseleave(function() {
                        $(this).removeClass("draggable");
                    });

                    $(this).resizable({
                         //grid: [ 10, 10 ],
                         handles: "ne, nw, se, sw",
                         /*handles: { 'ne': '.ui-resizable-handle.ui-resizable-ne', 'nw': '.ui-resizable-handle.ui-resizable-nw', 'se': '.ui-resizable-handle.ui-resizable-se', 'sw': '.ui-resizable-handle.ui-resizable-sw'},*/

                         minWidth: -($(this).width()) * 10, // these need to be large and negative
                         minHeight: -($(this).height()) * 10, // so we can shrink our resizable while scaled
                         start: function(event, ui) {
                             /*
                             this.calcLeft = this._left;
                             this.calcTop = this._top;
                             this.resizeWidth = this._width;
                             this.resizeHeight = this._height;
                             */
                         },
                         resize: function(event, ui) {

                             /** get axis **/
                             var axis = $(event.target).data('uiResizable').axis;

                             /** calculate new dimensions (width, height, left, top) **/
                             var newWidth = getNewWidth(ui, this.getScale());

                             var newHeight = getNewHeight(ui, this.getScale());

                             var changeLeft = getChangeLeft(ui, this.getScale());
                             var newLeft = getNewLeft(ui, this.getScale());

                             var changeTop = getChangeTop(ui, this.getScale());
                             var newTop = getNewTop(ui, this.getScale());

                             var left = newWidth;
                             var top = newHeight;
                             var right = 0;
                             var bottom = 0;
                             $.each(this._tables, function() {
                                 left = left > (this.getLeft() + (changeLeft * -1)) ? (this.getLeft() + (changeLeft * -1)) : left;
                                 top = top > (this.getTop() + (changeTop * -1)) ? (this.getTop() + (changeTop * -1)) : top;
                                 right = right < (this.getLeft() + $(this).width()) ? (this.getLeft() + $(this).width()) : right;
                                 bottom = bottom < (this.getTop() + $(this).height()) ? (this.getTop() + $(this).height()) : bottom;
                             });
                             top = top - this.getHeaderHeight();

                             if (axis.indexOf("w") >= 0) {
                                 if (left <= getPadding()) {
                                     newWidth = newWidth - (left - getPadding());
                                     newLeft = newLeft + (left - getPadding());
                                 }
                             }
                             if (axis.indexOf("n") >= 0) {
                                 if (top <= 10) {
                                     newHeight = newHeight - (top - 10);
                                     newTop = newTop + (top - 10);
                                 }
                             }
                             if (axis.indexOf("e") >= 0) {
                                 if (right > (newWidth - 10)) {
                                     newWidth = right + 10;
                                 }
                             }
                             if (axis.indexOf("s") >= 0) {
                                 if (bottom > (newHeight - 10 - 30)) {
                                     newHeight = bottom + 10 + 30;
                                 }
                             }

                             this._width = newWidth;
                             ui.size.width = newWidth;
                             this._left = newLeft;
                             ui.position.left = newLeft;
                             this._height = newHeight;
                             ui.size.height = newHeight;
                             this._top = newTop;
                             ui.position.top = newTop;

                             changeLeft = ui.position.left - ui.originalPosition.left; // find change in left
                             changeTop = ui.position.top - ui.originalPosition.top; // find change in top

                             $.each(this._tables, function() {
                                 this.calcLeft(changeLeft * -1);
                                 this.calcTop(changeTop * -1);
                             });
                         },
                         stop: function() {
                             $.each(this._tables, function() {
                                 this.setCalcLeft();
                                 this.setCalcTop();
                             });

                             this.refreshMinimap();

                             this._visualizer.fireSchemaDraggedOrResized(this.schema.id, this._left, this._top, this._width, this._height);
                         }

                    });
                },
                getPosition() {
                    let position = $(this).css([ "left", "top", "width", "height" ]);
                    return {
                        left: parseInt(position.left, 10),
                        top: parseInt(position.top, 10),
                        width: parseInt(position.width, 10),
                        height: parseInt(position.height, 10)
                    };
                }
            });
</script>

<script src="../util/calc.js"></script>
</html>
