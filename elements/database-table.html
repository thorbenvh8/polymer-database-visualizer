<!DOCTYPE html>
<html>
<head>
    <link href="../bower_components/polymer/polymer.html" rel="import">
    <link href="database-column.html" rel="import">
    <link href="database-constraint.html" rel="import">
    <!-- Element Imports -->
</head>

<dom-module id="database-table">
    <style>
        /* CSS rules for your element */
    </style>
    <template>

        <div class$="database-view-div-header {{selectedClass(selected)}}">
            <h3>{{table.name}}</h3>
        </div>
        <div class="database-view-div-body">
            <template is="dom-repeat" items="{{table.columns}}">
                <database-column id="{{schemaname}}_{{table.name}}_{{item.name}}" schemaname="{{schemaname}}" tablename="{{table.name}}" column="{{item}}"></database-column>
            </template>
        </div>
        <div class="database-view-div-footer">
            <template is="dom-repeat" items="{{table.constraints}}">
                <database-constraint schemaname="{{schemaname}}" tablename="{{table.name}}" constraint="{{item}}"></database-constraint>
            </template>
        </div>

    </template>
</dom-module>
<script>
    Polymer({
                is: "database-table",
                properties: {
                    table: {
                        type: Object,
                        notify: true,
                        value: function() {
                            return {
                                name: "table1",
                                columns:  [{name: "column1"}]
                            };
                        }
                    },
                    schema: {
                        type: Object,
                        notify: true,
                        value: function() {
                            return {};
                        }
                    },
                    columns: {
                        type: Array,
                        notify: true,
                        value: function() {
                            return [];
                        }
                    },
                    constraints: {
                        type: Array,
                        notify: true,
                        value: function() {
                            return [];
                        }
                    },
                    schemaname: String,
                    left: Number,
                    top: Number,
                    width: Number,
                    height: Number,
                    selected: {
                        type: Boolean,
                        notify: true,
                        value: false,
                        observer: 'selectedChanged'
                    },
                    resizableLeft: Number,
                    resizableTop: Number
                },
                selectedChanged: function(value) {
                    var table = this;
                    $.each(this.constraints, function() {
                        this.highlight(value, table);
                    });
                },

                selectedClass(b) {
                    return b ? "background-color-tertiar" : "background-color-secondary";
                },

                registerColumn(column) {
                    this.columns.push(column);
                },

                resizeTop(resizableTop) {
                    this.resizableTop = this.top + resizableTop;
                    $(this).css({top: this.resizableTop});
                },
                resizeLeft(resizableLeft) {
                    this.resizableLeft = this.left + resizableLeft
                    $(this).css({left: this.resizableLeft});
                },

                setLeft(left) {
                    this.left = left;
                },

                setResizeLeft() {
                    this.top = this.resizableTop;
                },
                setResizeTop() {
                    this.left = this.resizableLeft;
                },

                ready: function() {

                },

                attached: function() {

                    this.left = parseInt(this.table.left);
                    this.top = parseInt(this.table.top);
                    this.width = $(this).width();
                    this.height = $(this).height();

                    this.schema = $('#'+this.schemaname)[0];
                    this.schema.registerTable(this);

                    $(this).css({
                        left: this.left,
                        top: this.top,
                        width: this.width,
                        height: this.height
                    });

                    $(this).first().on('mouseup', function(e) {
                        this.selected = !this.selected;
                    });

                    var selectedBeforeDrag;

                    $(this).draggable({
                        //grid: [10,10],
                        //handle: "> .database-view-div-header",
                        start: function(event, ui) {
                            ui.position.left = 0;
                            ui.position.top = 0;

                            selectedBeforeDrag = this.selected;
                            this.selected = true;
                            this.setDraggingChild(true);
                        },
                        drag: function(event, ui) {
                            function round(number, increment, offset) {
                                return Math.ceil((number - offset) / increment ) * increment + offset;
                            }

                            let draggingTable = this;

                            var changeLeft = ui.position.left - ui.originalPosition.left; // find change in left
                            var newLeft = ui.originalPosition.left + changeLeft / this.schema.getScale(); // adjust new left by our zoomScale

                            var changeTop = ui.position.top - ui.originalPosition.top; // find change in top
                            var newTop = ui.originalPosition.top + changeTop / this.schema.getScale(); // adjust new top by our zoomScale

                            let tablePosition = this.getPosition();
                            let schemaPosition = this.schema.getPosition();

                            // TODO change into function of element to change css and variable on element too
                            if (tablePosition.left + tablePosition.width > schemaPosition.left + schemaPosition.width - 10) {
                                this.schema.setWidth(schemaPosition.width + 10);
                            }
                            if (tablePosition.left < schemaPosition.left + 20) {
                                let diff = round(Math.abs(tablePosition.left - (schemaPosition.left + 20)), 10, 10);
                                this.schema.setWidth(schemaPosition.width + diff);
                                this.schema.setLeft(schemaPosition.left - diff);
                                $.each(this.schema.getTables(), function() {
                                    if (draggingTable !== this) {
                                        this.left = this.left + diff;
                                        $(this).css({left: this.left});
                                    }
                                });
                            }
                            if (tablePosition.top + tablePosition.height > schemaPosition.top + schemaPosition.height - 10 - 25) {
                                this.schema.setHeight(schemaPosition.height + 10);
                            }

                            // TODO remove 72
                            if (tablePosition.top < schemaPosition.top + 72 + 10) {
                                let diff = round(Math.abs(tablePosition.top - (schemaPosition.top + 72 + 10)), 10, 10);
                                this.schema.setHeight(schemaPosition.height + diff);
                                this.schema.setTop(schemaPosition.top - diff);
                                $.each(this.schema.getTables(), function() {
                                    if (draggingTable !== this) {
                                        this.top = this.top + diff;
                                        $(this).css({top: this.top});
                                    }
                                });

                            }

                            newLeft = newLeft <= 0 ? 10 : newLeft;
                            ui.position.left = newLeft;
                            // TODO try to remove this this.left updating while dragging, just do it in stop
                            this.left = newLeft;
                            newTop = newTop <= 75 ? 80 : newTop;
                            ui.position.top = newTop;
                            this.top = newTop;

                            $(this).css('left', newLeft + 'px');
                            $(this).css('top', newTop + 'px');

                            this.refresh();

                        },
                        stop: function(event, ui) {
                            // TODO make short and beautiful
                            var changeLeft = ui.position.left - ui.originalPosition.left; // find change in left
                            var newLeft = ui.originalPosition.left + changeLeft / this.schema.getScale(); // adjust new left by our zoomScale

                            var changeTop = ui.position.top - ui.originalPosition.top; // find change in top
                            var newTop = ui.originalPosition.top + changeTop / this.schema.getScale(); // adjust new top by our zoomScale

                            this.left = newLeft * this.schema.getScale();
                            this.top = newTop * this.schema.getScale();

                            this.refresh();
                            this.schema.refreshMinimap();
                            this.selected = selectedBeforeDrag;
                            this.setDraggingChild(false);
                        }
                    });
                },
                addConstraint(constraint) {
                    this.constraints.push(constraint);
                },
                setDraggingChild(b) {
                    this.schema.setDraggingChild(b);
                },
                refresh() {
                    $.each(this.constraints, function() {
                        this.refresh();
                    })
                },
                getPosition() {
                    let parent = this.schema.getPosition();
                    let position = $(this).css([ "left", "top", "width", "height" ]);
                    return {
                        left: parseInt(position.left, 10) + parseInt(parent.left, 10),
                        top: parseInt(position.top, 10) + parseInt(parent.top, 10),
                        width: $(this).width(),
                        height: $(this).height()
                    };
                }
            });
</script>
</html>
